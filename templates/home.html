<!DOCTYPE html>
<html>
<head>
    <title>Columbia Neurological Surgery - Patient Portal</title>
    <style>
        body {
            font-family: 'Times New Roman', Times, serif;
            font-size: 16px;
            padding: 30px;
            background-color: #f9f9f9;
            text-align: center;
        }

        img.logo {
            width: 300px;
            margin-bottom: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #ffffff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .chatbot-section {
            margin-bottom: 40px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .form-section {
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        button {
            background-color: #0033A0;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }

        button:hover {
            background-color: #001F5C;
        }

        h1 {
            color: #333;
            font-size: 32px;
        }

        h2 {
            color: #0033A0;
            font-size: 24px;
        }

        #chat-messages {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            text-align: left;
        }

        #chat-input {
            width: 70%;
            padding: 8px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <!-- Logo Image -->
    <img src="/static/logo.png" alt="Columbia Neurological Surgery Logo" class="logo">

    <div class="container">
        <h1>Welcome to Columbia Neurological Surgery</h1>
        
        <div class="chatbot-section">
            <h2>AI-Powered Intake Assistant</h2>
            <p>Our chatbot will help gather information about your condition to streamline your appointment.</p>
            
            <div id="chat-messages">
                <div style="color: #666; font-style: italic;">Chatbot: Hello! I'm here to help you with your appointment request. Let me ask you a few questions...</div>
            </div>
            
            <div>
                <input type="text" id="chat-input" placeholder="Type your response here...">
                <button onclick="sendMessage()">Send</button>
                <button onclick="startIntake()">Restart Intake</button>
            </div>
        </div>

        <div class="form-section">
            <h2>Or Fill Out Our Form Directly</h2>
            <p>If you prefer, you can skip the chatbot and fill out our appointment request form directly.</p>
            <button onclick="window.location.href='/form'">Go to Form</button>
        </div>

        <div style="margin-top: 30px;">
            <h2>Check Available Appointments</h2>
            <button onclick="checkAvailability()">View Availability</button>
            <div id="availability-display" style="margin-top: 15px; text-align: left;"></div>
        </div>
    </div>

    <script>
        let intakeData = {};

        // utility functions for messages and buttons
        function addBotMessage(text) {
            const messages = document.getElementById('chat-messages');
            const formatted = text.replace(/\n/g, "<br>");  // ðŸ”¥ this is key
            const wrapper = document.createElement('div');
            wrapper.style.margin = '10px 0';
            wrapper.style.color = '#666';
            wrapper.innerHTML = `<strong>Chatbot:</strong> ${text}`;
            messages.appendChild(wrapper);
            messages.scrollTop = messages.scrollHeight;
        }

        function addButtons(options) {
            const messages = document.getElementById('chat-messages');

            // ðŸ”´ Clear previous buttons if any exist
            const oldButtons = messages.querySelectorAll('div.button-row');
            oldButtons.forEach(btn => btn.remove());

            // ðŸŸ¢ Create a new row for the buttons
            const buttonRow = document.createElement('div');
            buttonRow.className = 'button-row'; // Add class for identification
            buttonRow.style.margin = "10px 0";

            options.forEach(option => {
                const btn = document.createElement('button');
                btn.innerText = option.label;
                btn.style.marginRight = "10px";
                btn.onclick = () => sendQuickResponse(option.value);
                buttonRow.appendChild(btn);
            });

            messages.appendChild(buttonRow);
            messages.scrollTop = messages.scrollHeight;
        }
        
// handle quick responses
        function sendQuickResponse(text) {
            const input = document.getElementById('chat-input');
            input.value = text;
            sendMessage();
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const messages = document.getElementById('chat-messages');

            if (input.value.trim() === '') return;

            const userText = input.value.trim();

            // Display user message
            messages.innerHTML += `<div style="margin: 10px 0; color: #0033A0;"><strong>You:</strong> ${userText}</div>`;

            // Send to intake API with user message
            fetch('/api/intake', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: userText })  // âœ… This is the fix
            })
            .then(response => response.json())
            .then(data => {
                const botReply = data.assistantMessage?.content || data.message || data.question;
                if (botReply) {
                    addBotMessage(botReply);
                    checkForButtons(botReply);
                }
            });


            input.value = '';
        }

        // auto-create buttons from responses
        function checkForButtons(botText) {
            const trimmed = botText.toLowerCase().replace(/\s+/g, ' ').trim();
            console.log("Checking for buttons in bot reply:", trimmed);
            const messages = document.getElementById('chat-messages');
            const oldButtons = messages.querySelectorAll('div.button-row');
                oldButtons.forEach(btn => btn.remove());

            // Main greeting with numbered options
            if (
                trimmed.includes("help you today") ||
                (trimmed.includes("schedule appointment") && trimmed.includes("imaging"))
            ) {
                addButtons([
                    { label: "Schedule appointment", value: "Schedule appointment" },
                    { label: "Imaging", value: "Imaging" },
                    { label: "Find doctors", value: "Find doctors" },
                    { label: "Other", value: "Other" }
                ]);
            }

            // Schedule follow-up
            if (trimmed.includes("what is your issue")) {
                addButtons([
                    { label: "Tumor", value: "tumor" },
                    { label: "Stroke/blood", value: "stroke" },
                    { label: "Spine", value: "spine" },
                    { label: "Pediatric", value: "pediatric" },
                    { label: "Other", value: "other" }
                ]);
            }

            // Tristate follow-up
            if (trimmed.includes("are you located in the tristate area")) {
                addButtons([
                    { label: "Yes", value: "Yes" },
                    { label: "No", value: "No" }
                ]);
            }
            // after provide/email
            if (trimmed.includes("would you like us to contact")) {
                addButtons([
                    { label: "Email", value: "email" },
                    { label: "Phone", value: "phone" },
                    { label: "Both", value: "both" }
                ]);
            }
            
            // Imaging follow
            if (trimmed.includes("need some more information") && trimmed.includes("do you")) {
              addButtons([
                { label: "Have imaging", value: "Have imaging" },
                { label: "Need imaging", value: "Need imaging" }
              ]);
            }

            if (trimmed.includes("connect you with an imaging")) {
                addButtons([
                    { label: "Yes", value: "Yes, I do" },
                    { label: "No", value: "No, I don't" }
                ]);
            }

            // Doctor follow
            if (trimmed.includes("interest in our providers")) {
                addButtons([
                    { label: "Spine", value: "spine surgeons" },
                    { label: "Tumor", value: "tumor surgeons" },
                    { label: "Pain", value: "peripheral surgeons" },
                    { label: "Pediatric", value: "pediatric surgeons" },
                    { label: "General", value: "general" }
                ]);
            }
                
        }


        function startIntake() {
            const messages = document.getElementById('chat-messages');
            messages.innerHTML = `<div style="margin: 10px 0; color: #666;"><strong>Chatbot:</strong> Starting intake...</div>`;

            fetch('/api/intake', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: "hello" })
            })
            .then(response => response.json())
            .then(data => {
                const botReply = data.assistantMessage?.content || data.message || data.question;
                if (botReply) {
                    addBotMessage(botReply);
                    checkForButtons(botReply); // trigger greeting
                }
            });
        }

        function checkAvailability() {
            fetch('/api/availability')
            .then(response => response.json())
            .then(data => {
                const display = document.getElementById('availability-display');
                let html = '<h3>Available Appointments:</h3><ul>';
                data.available_slots.forEach(slot => {
                    html += `<li>${slot.date} at ${slot.time}</li>`;
                });
                html += '</ul>';
                display.innerHTML = html;
            });
        }

        // Allow Enter key to send messages
document.getElementById('chat-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        // run greeting as soon as page loads
window.addEventListener('load', function () {
            startIntake();
             });
    </script>
</body>
</html>
